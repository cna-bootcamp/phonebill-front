name: Frontend CI/CD (Generic K8s)


on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package*.json'
      - 'tsconfig*.json'
      - 'vite.config.ts'
      - 'index.html'
      - '.github/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  # ============================================
  # 변경: Azure ACR → Docker Hub
  # ============================================
  REGISTRY: docker.io
  IMAGE_ORG: ${{ secrets.DOCKERHUB_USERNAME }}
  IMAGE_NAME: phonebill-front
  NAMESPACE: phonebill
  
  # SSH 터널링용
  MINIKUBE_IP: "192.168.49.2"

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set_outputs.outputs.image_tag }}
      environment: ${{ steps.set_outputs.outputs.environment }}

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Debug KUBECONFIG secret
        run: |
          echo "========== KUBECONFIG 디버깅 =========="
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "KUBECONFIG: 설정되지 않음 (empty)"
          else
            echo "KUBECONFIG: 설정됨"
            echo "KUBECONFIG 길이: ${#KUBECONFIG_VALUE} 문자"
            echo "Base64 디코드 테스트:"
            echo "${{ secrets.KUBECONFIG }}" | base64 -d | head -c 100 | cat -v || echo "Base64 디코드 실패"
            echo ""
          fi
          echo "============================================"
        env:
          KUBECONFIG_VALUE: ${{ secrets.KUBECONFIG }}

      - name: Set up Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Determine environment
        id: determine_env
        run: |
          echo "========== ENVIRONMENT 디버깅 =========="
          echo "vars.ENVIRONMENT: '${{ vars.ENVIRONMENT }}'"
          echo "============================================"
          ENVIRONMENT="${{ vars.ENVIRONMENT || 'dev' }}"
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Build and Test
        run: |
          npm run build
          npm run lint

      - name: Debug SKIP_SONARQUBE value
        run: |
          echo "========== SKIP_SONARQUBE 디버깅 =========="
          echo "vars.SKIP_SONARQUBE: '${{ vars.SKIP_SONARQUBE }}'"
          echo "Condition (vars.SKIP_SONARQUBE != 'true'): ${{ vars.SKIP_SONARQUBE != 'true' }}"
          echo "============================================"

      - name: SonarQube Analysis & Quality Gate
        if: ${{ vars.SKIP_SONARQUBE != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          npm install -g sonarqube-scanner
          sonar-scanner \
            -Dsonar.projectKey=phonebill-front-${{ steps.determine_env.outputs.environment }} \
            -Dsonar.projectName=phonebill-front-${{ steps.determine_env.outputs.environment }} \
            -Dsonar.sources=src \
            -Dsonar.tests=src \
            -Dsonar.test.inclusions=**/*.test.ts,**/*.test.tsx,**/*.spec.ts,**/*.spec.tsx \
            -Dsonar.exclusions=node_modules/**,dist/**,build/**,coverage/**,**/*.config.js,**/*.config.ts,scripts/** \
            -Dsonar.scm.disabled=true \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.typescript.tsconfigPaths=tsconfig.json \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
            -Dsonar.javascript.node.maxspace=4096 \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.token=$SONAR_TOKEN

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Set outputs
        id: set_outputs
        run: |
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)
          echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "environment=${{ steps.determine_env.outputs.environment }}" >> $GITHUB_OUTPUT

  release:
    name: Build and Push Docker Image
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ============================================
      # 변경: Docker Hub 로그인만 사용
      # ============================================
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: deployment/container/Dockerfile-frontend
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.environment }}-${{ needs.build.outputs.image_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.environment }}-latest
          build-args: |
            PROJECT_FOLDER=.
            BUILD_FOLDER=deployment/container
            EXPORT_PORT=8080

  deploy:
    name: Deploy to Kubernetes
    needs: [build, release]
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ needs.build.outputs.environment }}" >> $GITHUB_ENV

      # ============================================
      # 변경: Azure CLI/Login 제거 → SSH 터널링
      # ============================================
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/vm_key
          chmod 600 ~/.ssh/vm_key
          ssh-keyscan -H ${{ secrets.VM_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Create SSH tunnel to Minikube
        run: |
          ssh -i ~/.ssh/vm_key \
              -o StrictHostKeyChecking=no \
              -o ServerAliveInterval=60 \
              -L 8443:${{ env.MINIKUBE_IP }}:8443 \
              ${{ secrets.VM_USER }}@${{ secrets.VM_IP }} -N &
          
          sleep 5
          echo "✅ SSH tunnel established"

      # ============================================
      # 변경: az aks get-credentials → KUBECONFIG Secret
      # ============================================
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure kubectl via KUBECONFIG
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
          
          # server 주소를 localhost:8443으로 변경 (SSH 터널 통해 접근)
          sed -i 's|server:.*|server: https://127.0.0.1:8443|g' $HOME/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      # ============================================
      # 추가: Docker Hub pull secret 생성
      # ============================================
      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry dockerhub-secret \
            --docker-server=docker.io \
            --docker-username=${{ secrets.DOCKERHUB_USERNAME }} \
            --docker-password=${{ secrets.DOCKERHUB_PASSWORD }} \
            --namespace=${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Install Kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update Kustomize images and deploy
        run: |
          cd .github/kustomize/overlays/${{ env.ENVIRONMENT }}
          
          # ============================================
          # 변경: 이미지 경로를 Docker Hub로
          # ============================================
          kustomize edit set image \
            ${{ env.REGISTRY }}/${{ env.IMAGE_ORG }}/${{ env.IMAGE_NAME }}:${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}
          
          kubectl apply -k .

      - name: Wait for deployments to be ready
        run: |
          echo "Waiting for deployments to be ready..."
          kubectl -n ${{ env.NAMESPACE }} wait --for=condition=available deployment/${{ env.IMAGE_NAME }} --timeout=300s

      - name: Show deployment status
        run: |
          kubectl -n ${{ env.NAMESPACE }} get pods -o wide
          kubectl -n ${{ env.NAMESPACE }} get svc

      # ============================================
      # 추가: SSH 터널 정리
      # ============================================
      - name: Cleanup SSH tunnel
        if: always()
        run: |
          pkill -f "ssh.*8443" || true